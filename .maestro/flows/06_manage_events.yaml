# Manage Events Flow - E2E Test
# Tests: Organizer can create event, add crews, edit event, delete/add crews
# Requires: User with organizer privileges
# Environment variables needed:
#   - TEST_EMAIL: Login email
#   - TEST_PASSWORD: Login password
#   - TEST_CREW_CHIEF_FIRSTNAME: First name to search for crew chief
#   - TEST_CREW_CHIEF_LASTNAME: Last name to search for crew chief
# Tags: events, organizer

appId: com.brianrosen.stripcall
tags:
  - events
  - organizer

---
# Stop any running instance and launch fresh
- stopApp:
    appId: "com.brianrosen.stripcall"
- launchApp:
    appId: "com.brianrosen.stripcall"
    clearState: true

# Ensure we're logged in first
- runFlow: 01_login.yaml

# Navigate to Manage Events from the settings menu
- tapOn:
    id: "settings_menu_button"
- waitForAnimationToEnd
- tapOn:
    text: "Manage Events"
- waitForAnimationToEnd

# Verify we're on the Manage Events page
- assertVisible:
    text: "My Events"

# ========================================
# STEP 1: Create a new event
# ========================================

- tapOn:
    id: "manage_events_add_button"
- waitForAnimationToEnd

# Verify we're on Create Event page
- assertVisible:
    text: "Create Event"

# Fill in event details
- tapOn:
    id: "manage_event_name_field"
- inputText: "E2E Test Tournament"

- tapOn:
    id: "manage_event_city_field"
- inputText: "Test City"

- tapOn:
    id: "manage_event_state_field"
- inputText: "PA"

# Set start date (pick today)
- tapOn:
    id: "manage_event_start_date_button"
- waitForAnimationToEnd
- tapOn:
    text: "OK"
- waitForAnimationToEnd

# Set end date (pick today - will work for a one-day event)
- tapOn:
    id: "manage_event_end_date_button"
- waitForAnimationToEnd
- tapOn:
    text: "OK"
- waitForAnimationToEnd

# Strip numbering defaults to Sequential Numbers, leave it
# Hide keyboard and scroll down to reveal count field
- hideKeyboard
- scrollUntilVisible:
    element:
      id: "manage_event_count_field"
    direction: DOWN
    timeout: 5000

# Set strip count
- tapOn:
    id: "manage_event_count_field"
- inputText: "12"

# Hide keyboard and save the event
- hideKeyboard
- tapOn:
    id: "manage_event_save_button"
- waitForAnimationToEnd

# Verify success message
- assertVisible:
    text: "Event created successfully"

# Should navigate back to My Events list
- waitForAnimationToEnd
- assertVisible:
    text: "My Events"

# ========================================
# STEP 2: Open the event to add a crew
# ========================================

# Wait for the event list to reload after returning from create
- waitForAnimationToEnd
- extendedWaitUntil:
    visible:
      text: ".*E2E Test Tournament.*"
    timeout: 15000

# Find and tap our newly created event
- tapOn:
    text: ".*E2E Test Tournament.*"
- waitForAnimationToEnd

# Verify we're on Edit Event page
- assertVisible:
    text: "Edit Event"

# Wait for crew types to load (button only appears when types are available)
- extendedWaitUntil:
    visible:
      id: "manage_event_add_crew_button"
    timeout: 15000

# Verify the Crews section exists
- assertVisible:
    text: "Crews"

# ========================================
# STEP 3: Add first crew (Armorer) with crew leader
# ========================================

# Scroll to the add crew button and tap it
# Scroll up first to reset scroll position
- swipe:
    direction: DOWN
    duration: 400

- scrollUntilVisible:
    element:
      id: "manage_event_add_crew_button"
    direction: DOWN
    timeout: 10000
- tapOn:
    id: "manage_event_add_crew_button"

# Select crew type dialog should appear
- extendedWaitUntil:
    visible:
      text: "Select Crew Type"
    timeout: 10000

# Select Armorer crew type — tap the dropdown to open it, then select from list
- tapOn:
    text: "Choose crew type"
- waitForAnimationToEnd
- tapOn:
    text: "Armorer"
- waitForAnimationToEnd

# Name finder dialog should appear
- extendedWaitUntil:
    visible:
      text: "Find Crew Chief"
    timeout: 10000

# Search for a crew chief using first and last name
- tapOn:
    id: "name_finder_firstname_field"
- inputText: "Armorer"

- hideKeyboard
- tapOn:
    id: "name_finder_lastname_field"
- inputText: "One"

- hideKeyboard
- tapOn:
    id: "name_finder_search_button"

# Wait for search results
- waitForAnimationToEnd
- extendedWaitUntil:
    visible:
      id: "name_finder_result_0"
    timeout: 10000

# Tap on the first result
- tapOn:
    id: "name_finder_result_0"
- waitForAnimationToEnd

# Verify crew was added
- extendedWaitUntil:
    visible:
      text: "Crew added successfully"
    timeout: 10000

# Verify Armorer crew now shows in the list
- scrollUntilVisible:
    element:
      id: "manage_event_crew_card_0"
    direction: DOWN
    timeout: 5000
- assertVisible:
    id: "manage_event_crew_card_0"

# ========================================
# STEP 4: Exit and return to the event
# ========================================

# Go back to My Events by tapping the Back button
- tapOn:
    text: "Back"
- waitForAnimationToEnd

# Verify we're back on My Events
- extendedWaitUntil:
    visible:
      text: "My Events"
    timeout: 10000

# Tap our event again
- tapOn:
    text: ".*E2E Test Tournament.*"
- waitForAnimationToEnd

# Verify the Armorer crew is still there
- scrollUntilVisible:
    element:
      id: "manage_event_crew_card_0"
    direction: DOWN
    timeout: 10000
- assertVisible:
    id: "manage_event_crew_card_0"

# ========================================
# STEP 5: Edit event parameters
# ========================================

# Scroll up to city field first
- scrollUntilVisible:
    element:
      id: "manage_event_city_field"
    direction: UP
    timeout: 5000

# Change the city
- tapOn:
    id: "manage_event_city_field"
- eraseText:
    charactersToErase: 9
- inputText: "Updated City"

# Change strip numbering to Pods
- waitForAnimationToEnd
- tapOn:
    id: "manage_event_strip_numbering_dropdown"
- waitForAnimationToEnd
- tapOn:
    text: "Pods"
- waitForAnimationToEnd

# Update count for pods
- hideKeyboard
- scrollUntilVisible:
    element:
      id: "manage_event_count_field"
    direction: DOWN
    timeout: 5000
- tapOn:
    id: "manage_event_count_field"
- eraseText:
    charactersToErase: 2
- inputText: "4"

# Save changes
- hideKeyboard
- scrollUntilVisible:
    element:
      id: "manage_event_save_button"
    direction: DOWN
    timeout: 5000
- tapOn:
    id: "manage_event_save_button"
- waitForAnimationToEnd

# Verify success
- assertVisible:
    text: "Event updated successfully"

# ========================================
# STEP 6: Delete the Armorer crew
# ========================================

# Scroll to crew card area
- scrollUntilVisible:
    element:
      id: "manage_event_crew_card_0"
    direction: DOWN
    timeout: 10000

# Tap the delete button by its tooltip text
- tapOn:
    text: "Delete Crew"

# No confirmation dialog expected (crew has no activity)
# Wait for deletion success snackbar
- extendedWaitUntil:
    visible:
      text: "Crew deleted successfully"
    timeout: 10000

# ========================================
# STEP 7: Add two more crews (Medical and Armorer)
# ========================================

# Add Medical crew — wait for page to fully reload after delete
- waitForAnimationToEnd
# Wait for "No crews found" to confirm page reloaded after delete
- extendedWaitUntil:
    visible:
      text: "No crews found"
    timeout: 15000
# Scroll up to top, then back down to ensure button is properly positioned
- scrollUntilVisible:
    element:
      id: "manage_event_name_field"
    direction: UP
    timeout: 5000
- scrollUntilVisible:
    element:
      id: "manage_event_add_crew_button"
    direction: DOWN
    timeout: 10000
    centerElement: true
- tapOn:
    id: "manage_event_add_crew_button"
- extendedWaitUntil:
    visible:
      text: "Select Crew Type"
    timeout: 10000
- tapOn:
    text: "Choose crew type"
- waitForAnimationToEnd
- tapOn:
    text: "Medical"
- waitForAnimationToEnd

# Find crew chief
- extendedWaitUntil:
    visible:
      text: "Find Crew Chief"
    timeout: 10000
- tapOn:
    id: "name_finder_firstname_field"
- inputText: "Medical"
- hideKeyboard
- tapOn:
    id: "name_finder_lastname_field"
- inputText: "One"
- hideKeyboard
- tapOn:
    id: "name_finder_search_button"
- waitForAnimationToEnd
- extendedWaitUntil:
    visible:
      id: "name_finder_result_0"
    timeout: 10000
- tapOn:
    id: "name_finder_result_0"
- waitForAnimationToEnd
- extendedWaitUntil:
    visible:
      text: "Crew added successfully"
    timeout: 10000

# Add Armorer crew again — scroll up first, wait for button, then scroll down
- waitForAnimationToEnd
- scrollUntilVisible:
    element:
      id: "manage_event_name_field"
    direction: UP
    timeout: 5000
- extendedWaitUntil:
    visible:
      id: "manage_event_add_crew_button"
    timeout: 15000
- scrollUntilVisible:
    element:
      id: "manage_event_add_crew_button"
    direction: DOWN
    timeout: 10000
    centerElement: true
- tapOn:
    id: "manage_event_add_crew_button"
- extendedWaitUntil:
    visible:
      text: "Select Crew Type"
    timeout: 10000
- tapOn:
    text: "Choose crew type"
- waitForAnimationToEnd
- tapOn:
    text: "Armorer"
- waitForAnimationToEnd

# Find crew chief
- extendedWaitUntil:
    visible:
      text: "Find Crew Chief"
    timeout: 10000
- tapOn:
    id: "name_finder_firstname_field"
- inputText: "Armorer"
- hideKeyboard
- tapOn:
    id: "name_finder_lastname_field"
- inputText: "Two"
- hideKeyboard
- tapOn:
    id: "name_finder_search_button"
- waitForAnimationToEnd
- extendedWaitUntil:
    visible:
      id: "name_finder_result_0"
    timeout: 10000
- tapOn:
    id: "name_finder_result_0"
- waitForAnimationToEnd
- extendedWaitUntil:
    visible:
      text: "Crew added successfully"
    timeout: 10000

# Verify both crews are visible via their card ids
- scrollUntilVisible:
    element:
      id: "manage_event_crew_card_0"
    direction: DOWN
    timeout: 10000
- assertVisible:
    id: "manage_event_crew_card_0"
- scrollUntilVisible:
    element:
      id: "manage_event_crew_card_1"
    direction: DOWN
    timeout: 10000
- assertVisible:
    id: "manage_event_crew_card_1"

# ========================================
# STEP 8: Final verification
# ========================================

# Go back to My Events to verify event is saved
- tapOn:
    text: "Back"
- waitForAnimationToEnd
- extendedWaitUntil:
    visible:
      text: "My Events"
    timeout: 10000

# Verify our event is in the list
- assertVisible:
    text: ".*E2E Test Tournament.*"
# Test complete - event created, crews added/deleted, parameters edited
